name: Deploy via Port

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: "Service name"
        required: true
        type: string
      image_tag:
        description: "Image tag to deploy"
        required: true
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitOps repo
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.34.1/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq

      - name: Ensure environment directory exists
        run: mkdir -p environments/minikube

      - name: Create or update ArgoCD YAML
        run: |
          FILE="environments/minikube/${{ inputs.service_name }}.yaml"
          SERVICE="${{ inputs.service_name }}"
          IMAGE="${{ inputs.image_tag }}"

          if [ ! -f "$FILE" ]; then
            echo "Creating new ArgoCD application file: $FILE"
            yq -n \
              --arg name "$SERVICE" \
              --arg repo "https://github.com/hoppetoss/$SERVICE.git" \
              --arg image "$IMAGE" \
              '{
                apiVersion: "argoproj.io/v1alpha1",
                kind: "Application",
                metadata: {name: $name, namespace: "argocd"},
                spec: {
                  project: "default",
                  source: {
                    repoURL: $repo,
                    targetRevision: "main",
                    path: "helm/fastapi-service",
                    helm: {parameters: [{name: "image.tag", value: $image}]}
                  },
                  destination: {server: "https://kubernetes.default.svc", namespace: "default"},
                  syncPolicy: {automated: {prune: true, selfHeal: true}}
                }
              }' > "$FILE"
          else
            echo "File exists â€” updating image tag in $FILE"
            yq -i \
              --arg image "$IMAGE" \
              '.spec.source.helm.parameters |=
                 (map(select(.name == "image.tag").value = $image)
                 + (if any(.name == "image.tag") then [] else [{"name":"image.tag","value":$image}] end))' \
              "$FILE"
          fi

      - name: Commit and push changes
        run: |
          git config --global user.email "platform-bot@hoppetoss.com"
          git config --global user.name "Hoppetoss Platform Bot"

          git add environments/minikube
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Deploy ${{ inputs.service_name }}:${{ inputs.image_tag }}"
          git push
